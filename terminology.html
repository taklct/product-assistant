<!DOCTYPE html>
<html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="scripts/sidebar.js" defer></script>
    <script src="scripts/sidebar-favorites.js" defer></script>
    <script src="scripts/sidebar-projects.js" defer></script>
    <script src="scripts/sidebar-chats.js" defer></script>
    <script src="scripts/sidebar-init.js" defer></script>
    <script src="scripts/spa-navigation.js" defer></script>
    <script src="scripts/topbar.js" defer></script>
    
    <style>
        ::-webkit-scrollbar { display: none;}
        body { font-family: 'Inter', sans-serif; }
        .nav-item { transition: all 0.2s ease-in-out; }
        .nav-item:hover { transform: translateX(2px); }
        .control-btn { transition: all 0.2s ease-in-out; }
        .control-btn:hover { transform: scale(1.02); }
        .card-hover { transition: all 0.3s ease-in-out; }
        .card-hover:hover { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); transform: translateY(-1px); }
        .term-row:hover .actions { opacity: 1; }
        #sidebar { transition: width 0.3s ease, transform 0.3s ease; }
        @media (min-width: 1024px) {
            #sidebar { height: 100vh; }
        }
        #sidebar.collapsed { width: 80px; }
        #sidebar.collapsed .sidebar-collapsible { display: none !important; }
        #sidebar.collapsed .sidebar-icon-only {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        #sidebar.collapsed .sidebar-icon-only > :not(:first-child) {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        #sidebar.collapsed .sidebar-icon-only .fa-solid,
        #sidebar.collapsed .sidebar-icon-only .fa-regular { margin-right: 0; }
        #sidebar.collapsed .control-btn i { margin-right: 0; }
        #sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 40;
            visibility: hidden;
        }
        #sidebar-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }
        body.sidebar-mobile-open { overflow: hidden; }
        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                inset: 0 auto 0 0;
                width: 280px;
                transform: translateX(-100%);
                box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
                z-index: 50;
            }
            #sidebar.mobile-open { transform: translateX(0); }
            #sidebar.collapsed { width: 280px; }
        }
    </style>
    <script>tailwind.config = {
  "theme": {
    "extend": {
      "fontFamily": {
        "inter": [
          "Inter",
          "sans-serif"
        ]
      },
      "colors": {
        "navy": "#0908c3",
        "sky": "#87CEEB"
      }
    }
  }
};</script>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"><style>
  .highlighted-section {
    outline: 2px solid #3F20FB;
    background-color: rgba(63, 32, 251, 0.1);
  }

  .edit-button {
    position: absolute;
    z-index: 1000;
  }

  ::-webkit-scrollbar {
    display: none;
  }

  html, body {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  </style></head>
<body class="bg-gray-50" data-active-sidebar-link="terminology">

<div id="terminology-interface" class="relative flex flex-col lg:flex-row min-h-screen lg:h-screen w-full bg-gray-50 text-gray-900 font-inter">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-[280px] bg-white border-r border-gray-200 flex flex-col shadow-sm transition-all duration-300 flex-shrink-0 min-h-0 lg:max-h-screen overflow-y-auto">
        <!-- Header -->
        <div id="sidebar-header" class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
            <div class="flex items-center space-x-2 sidebar-icon-only">
                <div class="w-9 h-9 bg-navy rounded-xl flex items-center justify-center shadow-md">
                    <i class="fa-solid fa-robot text-white text-base"></i>
                </div>
                <h1 class="text-base font-semibold text-gray-800 sidebar-collapsible">AI Assistant</h1>
            </div>
            <button id="sidebar-toggle" class="p-2 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100 transition-colors" aria-label="Collapse sidebar" aria-expanded="true">
                <i class="fa-solid fa-chevron-left text-sm" data-icon-collapse></i>
                <i class="fa-solid fa-chevron-right text-sm hidden" data-icon-expand></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div id="new-chat-section" class="px-3 py-2 space-y-2">
            <button id="sidebar-new-chat" class="w-full flex items-center justify-center bg-navy text-white rounded-xl h-8 text-sm font-medium hover:bg-navy/90 shadow-md control-btn">
                <i class="fa-solid fa-plus mr-2"></i> <span class="sidebar-collapsible">New Chat</span>
            </button>
        </div>

        <!-- Dashboard Navigation -->
        <div id="dashboard-nav" class="px-4 pb-2.5">
            <div class="space-y-0.5">
                <a href="dashboard.html" class="w-full flex items-center space-x-2.5 px-3 py-1.5 rounded-xl hover:bg-gray-50 text-gray-600 text-left nav-item sidebar-icon-only" data-sidebar-link="dashboard">
                    <i class="fa-solid fa-chart-line text-sm"></i>
                    <span class="text-sm sidebar-collapsible">Dashboard</span>
                </a>
                <a href="terminology.html" class="w-full flex items-center space-x-2.5 px-3 py-1.5 rounded-xl hover:bg-gray-50 text-gray-600 text-left nav-item sidebar-icon-only" data-sidebar-link="terminology">
                    <i class="fa-solid fa-book text-sm"></i>
                    <span class="text-sm sidebar-collapsible">Terminology</span>
                </a>
                <div class="space-y-1.5" data-favorites-section>
                    <button type="button" class="w-full flex items-center justify-between px-3 py-1.5 rounded-xl hover:bg-gray-50 text-gray-600 text-left nav-item sidebar-icon-only" data-sidebar-link="favorites">
                        <div class="flex items-center space-x-2.5 min-w-0 sidebar-icon-only">
                            <i class="fa-solid fa-star text-sm"></i>
                            <span class="text-sm sidebar-collapsible">Favorites</span>
                        </div>
                        <span class="hidden text-xs font-semibold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full sidebar-collapsible" data-favorites-count></span>
                    </button>
                    <div class="pl-9 pr-2 space-y-2 hidden sidebar-collapsible" data-favorites-view>
                        <div class="text-xs font-semibold text-gray-500">Favorites</div>
                        <div class="space-y-2 hidden" data-favorites-list></div>
                        <div class="rounded-lg border border-dashed border-gray-300 p-3 text-xs text-gray-500" data-favorites-empty>
                            <p class="font-medium text-gray-600">No favorites yet</p>
                            <p class="mt-1">Use the favorite controls within each page to pin items here for quick access.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Project and Project Folders -->
        <div id="project-section" class="px-4 pb-2.5" data-project-section>
            <div class="flex items-center justify-between px-3 pb-1.5 sidebar-collapsible">
                <span class="text-xs font-semibold tracking-wide text-gray-400 uppercase">Projects</span>
                <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" data-projects-toggle aria-expanded="true">
                    <span class="sr-only">Toggle project folders</span>
                    <i class="fa-solid fa-chevron-down text-xs" data-projects-icon="expanded"></i>
                    <i class="fa-solid fa-chevron-right text-xs hidden" data-projects-icon="collapsed"></i>
                </button>
            </div>
            <div class="space-y-0.5" data-projects-content>
                <a href="create-project.html" class="flex items-center justify-between px-3 py-1.5 rounded-xl hover:bg-gray-50 text-gray-600 cursor-pointer nav-item" data-sidebar-link="new-project">
                    <div class="flex items-center space-x-2.5 min-w-0 sidebar-icon-only">
                        <i class="fa-solid fa-folder-plus text-sm"></i>
                        <span class="text-sm sidebar-collapsible">New Project</span>
                    </div>
                </a>

                <div data-project-folders class="space-y-0.5"></div>
            </div>
        </div>

        <!-- Chat History -->
        <nav id="chat-history" class="flex-1 overflow-y-auto px-4 space-y-1" data-chats-section>
            <div class="flex items-center justify-between px-3 pb-1.5 sidebar-collapsible">
                <span class="text-xs font-semibold tracking-wide text-gray-400 uppercase">Chats</span>
                <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" data-chats-toggle aria-expanded="true">
                    <span class="sr-only">Toggle chats</span>
                    <i class="fa-solid fa-chevron-down text-xs" data-chats-icon="expanded"></i>
                    <i class="fa-solid fa-chevron-right text-xs hidden" data-chats-icon="collapsed"></i>
                </button>
            </div>
            <div class="space-y-0.5" data-chats-content>
                <div data-chat-history class="space-y-0.5"></div>
            </div>
        </nav>

        <!-- User Profile -->
        <div id="user-profile" class="border-t border-gray-200 p-2">
            <div class="flex items-center space-x-2 px-2.5 py-1 rounded-xl hover:bg-gray-50 cursor-pointer nav-item sidebar-icon-only">
                <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" alt="User Avatar" class="w-8 h-8 rounded-full">
                <div class="flex-1 min-w-0 sidebar-collapsible">
                    <div class="flex items-center space-x-1.5">
                        <p class="text-sm font-medium text-gray-800 truncate">John Smith</p>
                        <span class="inline-flex items-center justify-center w-2 h-2 rounded-full bg-green-500" role="status" aria-label="Online"></span>
                    </div>
                    <p class="text-xs text-gray-500">Product Owner</p>
                </div>
                <i class="fa-solid fa-gear text-gray-400 hover:text-gray-600 sidebar-collapsible"></i>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 flex flex-col bg-white order-2 lg:order-none min-h-0 lg:max-h-screen lg:overflow-hidden">
        <!-- Navigation Bar -->
        <header id="header"
            data-topbar
            data-topbar-title="Terminology"
            data-topbar-icon="fa-solid fa-book"
            data-topbar-icon-color="text-navy"
            data-topbar-icon-bg="bg-navy/10">
            <div data-topbar-leading class="flex items-center space-x-2">
                <button id="mobile-sidebar-toggle" class="lg:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors" aria-label="Open sidebar">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
            <div data-topbar-actions>
                <button id="export-button" class="px-5 py-2.5 border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-full transition-all text-sm font-medium control-btn">
                    <i class="fa-solid fa-upload mr-2"></i> Export
                </button>
                <button id="add-term-button" class="px-5 py-2.5 bg-navy text-white hover:bg-navy/90 rounded-full transition-all text-sm font-medium control-btn">
                    <i class="fa-solid fa-plus mr-2"></i> Add Term
                </button>
            </div>
        </header>

        <!-- Terminology Content -->
        <div id="terminology-content" class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <div class="max-w-full mx-auto">
                <!-- Filters Section -->
                <div id="filters-section" class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-xl">
                    <div class="flex flex-wrap items-center gap-3 sm:flex-nowrap sm:gap-4">
                        <div class="relative flex-grow">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input id="term-search-input" type="text" placeholder="Search term, definition, synonyms..." class="w-full pl-12 pr-4 py-3 bg-white border border-gray-300 rounded-lg text-sm placeholder-gray-500 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none" aria-label="Search terminology entries">
                        </div>
                        <button id="bulk-edit-button" class="px-4 py-3 border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg transition-all text-sm font-medium">
                            Bulk Edit
                        </button>
                    </div>
                </div>

                <div id="bulk-edit-toolbar" class="hidden mb-4 px-4 py-3 bg-navy/5 border border-navy/20 rounded-lg flex flex-wrap items-center justify-between gap-3">
                    <p class="text-sm text-gray-700 font-medium">Bulk edit mode is active. Update the fields below, then choose Save Changes.</p>
                    <div class="flex items-center gap-2">
                        <button id="bulk-cancel-button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-100 transition-colors">Cancel</button>
                        <button id="bulk-save-button" class="px-4 py-2 bg-navy text-white rounded-lg text-sm hover:bg-navy/90 transition-colors">Save Changes</button>
                    </div>
                </div>

                <!-- Terms Table -->
                <div id="terms-table" class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="min-w-full">
        <!-- Table Header -->
        <div class="grid grid-cols-12 gap-4 px-6 py-4 bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider">
            <div class="col-span-3">Term (Canonical)</div>
            <div class="col-span-4">Definition</div>
            <div class="col-span-2">Synonyms</div>
            <div class="col-span-2">Last Change</div>
            <div class="col-span-1 text-right">Actions</div>
        </div>
        <!-- Table Body -->
        <div id="terms-body" class="divide-y divide-gray-200"></div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
        <div class="flex items-center text-sm text-gray-600">
            <span id="pagination-summary">Showing 0-0 of 0 terms</span>
        </div>
        <div class="flex items-center space-x-2">
            <button id="pagination-prev" type="button" class="px-3 py-2 text-sm text-gray-400 hover:text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa-solid fa-chevron-left mr-1"></i>Previous
            </button>
            <div id="pagination-pages" class="flex items-center space-x-1"></div>
            <button id="pagination-next" type="button" class="px-3 py-2 text-sm text-gray-600 hover:text-navy disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Next<i class="fa-solid fa-chevron-right ml-1"></i>
            </button>
        </div>
    </div>
</div>
</div>
</div>
</main>

    <div id="sidebar-backdrop" aria-hidden="true"></div>

<div id="add-term-backdrop" class="hidden fixed inset-0 bg-gray-900/40 backdrop-blur-sm opacity-0 transition-opacity duration-300 z-40" aria-hidden="true"></div>

<aside id="add-term-panel" class="hidden fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col" role="dialog" aria-modal="true" aria-labelledby="add-term-panel-title" aria-hidden="true">
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
        <h3 id="add-term-panel-title" class="text-lg font-semibold text-gray-800">Add New Term</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700 transition-colors" data-close-panel>
            <span class="sr-only">Close panel</span>
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
    </div>
    <form id="add-term-form" class="flex-1 overflow-y-auto px-6 py-4 space-y-5">
        <div>
            <label for="term-name" class="block text-sm font-medium text-gray-700">Term Name</label>
            <input id="term-name" data-first-field type="text" class="mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-800 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none" placeholder="Enter term name">
        </div>
        <div>
            <label for="term-definition" class="block text-sm font-medium text-gray-700">Definition</label>
            <textarea id="term-definition" class="mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-800 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none" rows="4" placeholder="Provide a concise definition"></textarea>
        </div>
        <div>
            <label for="term-synonyms" class="block text-sm font-medium text-gray-700">Synonyms</label>
            <input id="term-synonyms" type="text" class="mt-2 w-full border border-gray-300 rounded-lg px-4 py-2 text-sm text-gray-800 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none" placeholder="Comma-separated synonyms">
        </div>
    </form>
    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-end space-x-3">
        <button type="button" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-100 transition-colors" data-close-panel>Cancel</button>
        <button type="submit" form="add-term-form" formnovalidate class="px-4 py-2 bg-navy text-white rounded-lg text-sm hover:bg-navy/90 transition-colors">Save Term</button>
    </div>
</aside>

</div>

<script>
(function () {
    const PAGE_KEY = 'terminology';
    let initialized = false;

    const init = () => {
        if (initialized) {
            return;
        }

            const termsBody = document.getElementById('terms-body');
            const paginationSummary = document.getElementById('pagination-summary');
            const paginationPrevButton = document.getElementById('pagination-prev');
            const paginationNextButton = document.getElementById('pagination-next');
            const paginationPagesContainer = document.getElementById('pagination-pages');
            const searchInput = document.getElementById('term-search-input');
            const bulkEditButton = document.getElementById('bulk-edit-button');
            const bulkToolbar = document.getElementById('bulk-edit-toolbar');
            const bulkCancelButton = document.getElementById('bulk-cancel-button');
            const bulkSaveButton = document.getElementById('bulk-save-button');
            const exportButton = document.getElementById('export-button');
            const addTermButton = document.getElementById('add-term-button');
            const panel = document.getElementById('add-term-panel');
            const backdrop = document.getElementById('add-term-backdrop');
            const firstField = panel ? panel.querySelector('[data-first-field]') : null;
            const closeTriggers = panel ? panel.querySelectorAll('[data-close-panel]') : [];
            const panelTitle = document.getElementById('add-term-panel-title');
            const addTermForm = document.getElementById('add-term-form');
            const termNameInput = document.getElementById('term-name');
            const termDefinitionInput = document.getElementById('term-definition');
            const termSynonymsInput = document.getElementById('term-synonyms');
            let lastFocusedElement = null;

            if (
                !termsBody ||
                !paginationSummary ||
                !bulkEditButton ||
                !bulkToolbar ||
                !bulkCancelButton ||
                !bulkSaveButton ||
                !exportButton ||
                !addTermButton ||
                !panel ||
                !backdrop ||
                !firstField ||
                !panelTitle ||
                !addTermForm ||
                !termNameInput ||
                !termDefinitionInput ||
                !termSynonymsInput ||
                !paginationPrevButton ||
                !paginationNextButton ||
                !paginationPagesContainer ||
                !searchInput
            ) {
                return;
            }

            initialized = true;

            const initialTermsData = [
                { term: 'Interactive Brokers', definition: 'Prime broker and API provider.', synonyms: ['IB', 'IBKR'], lastChange: '2025-09-29 09:14:06' },
                { term: 'PAMM', definition: 'Percentage Allocation Management Module, a form of pooled money forex trading.', synonyms: ['Percent Allocation'], lastChange: '2025-08-15 11:30:00' },
                { term: 'KYC', definition: 'Know Your Customer, the process of a business verifying the identity of its clients.', synonyms: ['Know Your Client'], lastChange: '2025-07-20 16:45:12' },
                { term: 'API', definition: 'Application Programming Interface, a way for two or more computer programs to communicate.', synonyms: ['Interface'], lastChange: '2025-06-01 10:05:30' },
                { term: 'Forex', definition: 'Foreign exchange market, a global decentralized market for trading currencies.', synonyms: ['FX', 'Currency Exchange'], lastChange: '2025-05-12 14:20:45' },
                { term: 'Spread', definition: 'The difference between the bid and ask prices of a trading instrument.', synonyms: ['Bid-Ask Spread'], lastChange: '2025-04-08 13:55:22' },
                { term: 'Leverage', definition: 'The use of borrowed capital to increase the potential return of an investment.', synonyms: ['Margin Trading'], lastChange: '2025-03-15 08:30:15' },
                { term: 'Slippage', definition: 'The difference between the expected price of a trade and the price at which the trade is executed.', synonyms: ['Price Deviation'], lastChange: '2025-02-28 17:22:40' },
                { term: 'Liquidity', definition: 'The ease with which an asset can be bought or sold in the market without affecting its price.', synonyms: ['Market Depth'], lastChange: '2025-01-10 12:45:18' },
                { term: 'Stop Loss', definition: 'An order to sell a security when it reaches a certain price to limit potential losses.', synonyms: ['SL', 'Stop Order'], lastChange: '2024-12-05 15:10:33' }
            ];

            let nextId = 1;
            const pageSize = 5;

            const state = {
                terms: initialTermsData.map((item) => ({ ...item, id: nextId++ })),
                bulkEditMode: false,
                editingTermId: null,
                searchQuery: '',
                currentPage: 1
            };

            const pad = (value) => String(value).padStart(2, '0');

            const formatDisplayDate = (value) => {
                if (value instanceof Date) {
                    return `${value.getFullYear()}-${pad(value.getMonth() + 1)}-${pad(value.getDate())} ${pad(value.getHours())}:${pad(value.getMinutes())}:${pad(value.getSeconds())}`;
                }

                const normalized = typeof value === 'string' ? value.replace(' ', 'T') : value;
                const parsed = new Date(normalized);

                if (Number.isNaN(parsed.getTime())) {
                    return typeof value === 'string' ? value : '';
                }

                return `${parsed.getFullYear()}-${pad(parsed.getMonth() + 1)}-${pad(parsed.getDate())} ${pad(parsed.getHours())}:${pad(parsed.getMinutes())}:${pad(parsed.getSeconds())}`;
            };

            const toDateTimeLocalValue = (value) => {
                if (!value) {
                    return '';
                }

                const normalized = typeof value === 'string' ? value.replace(' ', 'T') : value;
                const parsed = new Date(normalized);

                if (Number.isNaN(parsed.getTime())) {
                    return '';
                }

                return `${parsed.getFullYear()}-${pad(parsed.getMonth() + 1)}-${pad(parsed.getDate())}T${pad(parsed.getHours())}:${pad(parsed.getMinutes())}:${pad(parsed.getSeconds())}`;
            };

            const parseSynonyms = (value) => value.split(',').map((item) => item.trim()).filter(Boolean);

            const createSynonymBadge = (text) => {
                const badge = document.createElement('span');
                badge.className = 'px-2 py-1 bg-gray-100 text-gray-700 rounded-md text-xs';
                badge.textContent = text;
                return badge;
            };

            const escapeCsvValue = (raw) => {
                const value = String(raw ?? '');
                if (/[",\n]/.test(value)) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            };

            const getFilteredTerms = () => {
                const query = state.searchQuery.trim().toLowerCase();
                if (!query) {
                    return [...state.terms];
                }

                return state.terms.filter((term) => {
                    const name = String(term.term ?? '').toLowerCase();
                    const definition = String(term.definition ?? '').toLowerCase();
                    const synonymsText = term.synonyms
                        .map((synonym) => String(synonym ?? '').toLowerCase())
                        .join(' ');

                    return (
                        name.includes(query) ||
                        definition.includes(query) ||
                        synonymsText.includes(query)
                    );
                });
            };

            const updateSummary = (start, end, total, isFiltering) => {
                const label = isFiltering ? 'matching terms' : 'terms';
                paginationSummary.textContent = `Showing ${start}-${end} of ${total} ${label}`;
            };

            const updateControlsAvailability = () => {
                const hasTerms = state.terms.length > 0;
                bulkEditButton.disabled = !hasTerms;
                exportButton.disabled = !hasTerms;
                bulkEditButton.classList.toggle('opacity-60', !hasTerms);
                bulkEditButton.classList.toggle('cursor-not-allowed', !hasTerms);
                exportButton.classList.toggle('opacity-60', !hasTerms);
                exportButton.classList.toggle('cursor-not-allowed', !hasTerms);
                bulkEditButton.setAttribute('aria-disabled', hasTerms ? 'false' : 'true');
                exportButton.setAttribute('aria-disabled', hasTerms ? 'false' : 'true');
            };

            const renderEmptyState = (message) => {
                const emptyRow = document.createElement('div');
                emptyRow.className = 'px-6 py-12 text-center text-sm text-gray-500';
                emptyRow.textContent = message;
                termsBody.appendChild(emptyRow);
            };

            const renderDisplayRow = (term) => {
                const row = document.createElement('div');
                row.className = 'term-row grid grid-cols-12 gap-4 px-6 py-4 items-center hover:bg-gray-50 transition-colors duration-150';
                row.dataset.termId = String(term.id);

                const termColumn = document.createElement('div');
                termColumn.className = 'col-span-3';
                const termName = document.createElement('p');
                termName.className = 'text-sm font-medium text-gray-800';
                termName.textContent = term.term;
                termColumn.appendChild(termName);

                const definitionColumn = document.createElement('div');
                definitionColumn.className = 'col-span-4 text-sm text-gray-600';
                definitionColumn.textContent = term.definition;

                const synonymsColumn = document.createElement('div');
                synonymsColumn.className = 'col-span-2 flex flex-wrap gap-1';
                if (term.synonyms.length === 0) {
                    const placeholder = document.createElement('span');
                    placeholder.className = 'text-xs text-gray-400';
                    placeholder.textContent = '—';
                    synonymsColumn.appendChild(placeholder);
                } else {
                    term.synonyms.forEach((synonym) => {
                        synonymsColumn.appendChild(createSynonymBadge(synonym));
                    });
                }

                const lastChangeColumn = document.createElement('div');
                lastChangeColumn.className = 'col-span-2 text-sm text-gray-600';
                lastChangeColumn.textContent = term.lastChange;

                const actionsColumn = document.createElement('div');
                actionsColumn.className = 'actions col-span-1 flex justify-end space-x-3 opacity-0 transition-opacity';

                const editButton = document.createElement('button');
                editButton.type = 'button';
                editButton.className = 'text-gray-400 hover:text-navy';
                editButton.setAttribute('aria-label', `Edit ${term.term}`);
                editButton.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                editButton.addEventListener('click', () => {
                    openTermPanel('edit', term.id);
                });

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'text-gray-400 hover:text-red-500';
                deleteButton.setAttribute('aria-label', `Delete ${term.term}`);
                deleteButton.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteButton.addEventListener('click', () => {
                    handleDeleteTerm(term.id);
                });

                actionsColumn.append(editButton, deleteButton);

                row.append(termColumn, definitionColumn, synonymsColumn, lastChangeColumn, actionsColumn);
                return row;
            };

            const renderBulkRow = (term) => {
                const row = document.createElement('div');
                row.className = 'term-row grid grid-cols-12 gap-4 px-6 py-4 items-start bg-white';
                row.dataset.termId = String(term.id);

                const termColumn = document.createElement('div');
                termColumn.className = 'col-span-3 flex flex-col gap-2';
                const termLabel = document.createElement('span');
                termLabel.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                termLabel.textContent = 'Term';
                const termInput = document.createElement('input');
                termInput.type = 'text';
                termInput.value = term.term;
                termInput.className = 'border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-800 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none';
                termInput.setAttribute('data-field', 'term');
                termColumn.append(termLabel, termInput);

                const definitionColumn = document.createElement('div');
                definitionColumn.className = 'col-span-4 flex flex-col gap-2';
                const definitionLabel = document.createElement('span');
                definitionLabel.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                definitionLabel.textContent = 'Definition';
                const definitionInput = document.createElement('textarea');
                definitionInput.rows = 3;
                definitionInput.value = term.definition;
                definitionInput.className = 'border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none resize-none';
                definitionInput.setAttribute('data-field', 'definition');
                definitionColumn.append(definitionLabel, definitionInput);

                const synonymsColumn = document.createElement('div');
                synonymsColumn.className = 'col-span-2 flex flex-col gap-2';
                const synonymsLabel = document.createElement('span');
                synonymsLabel.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                synonymsLabel.textContent = 'Synonyms';
                const synonymsInput = document.createElement('input');
                synonymsInput.type = 'text';
                synonymsInput.value = term.synonyms.join(', ');
                synonymsInput.placeholder = 'Comma-separated';
                synonymsInput.className = 'border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none';
                synonymsInput.setAttribute('data-field', 'synonyms');
                synonymsColumn.append(synonymsLabel, synonymsInput);

                const lastChangeColumn = document.createElement('div');
                lastChangeColumn.className = 'col-span-2 flex flex-col gap-2';
                const lastChangeLabel = document.createElement('span');
                lastChangeLabel.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide';
                lastChangeLabel.textContent = 'Last Change';
                const lastChangeInput = document.createElement('input');
                lastChangeInput.type = 'datetime-local';
                lastChangeInput.value = toDateTimeLocalValue(term.lastChange);
                lastChangeInput.className = 'border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-700 focus:ring-2 focus:ring-navy/50 focus:border-navy focus:outline-none';
                lastChangeInput.setAttribute('data-field', 'lastChange');
                lastChangeColumn.append(lastChangeLabel, lastChangeInput);

                const actionsColumn = document.createElement('div');
                actionsColumn.className = 'col-span-1 flex items-center justify-end text-xs font-semibold text-gray-500 uppercase tracking-wide';
                actionsColumn.textContent = 'Editing';

                row.append(termColumn, definitionColumn, synonymsColumn, lastChangeColumn, actionsColumn);
                return row;
            };

            const renderPaginationControls = (totalItems, totalPages) => {
                const hasItems = totalItems > 0;

                paginationPrevButton.disabled = !hasItems || state.currentPage <= 1;
                paginationNextButton.disabled = !hasItems || state.currentPage >= totalPages;

                paginationPrevButton.setAttribute('aria-disabled', paginationPrevButton.disabled ? 'true' : 'false');
                paginationNextButton.setAttribute('aria-disabled', paginationNextButton.disabled ? 'true' : 'false');

                paginationPagesContainer.innerHTML = '';

                if (!hasItems || totalPages <= 1) {
                    return;
                }

                const addPageButton = (page) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = String(page);
                    button.className = page === state.currentPage
                        ? 'px-3 py-2 text-sm bg-navy text-white rounded-md'
                        : 'px-3 py-2 text-sm text-gray-600 hover:text-navy hover:bg-gray-100 rounded-md';
                    button.addEventListener('click', () => {
                        if (page === state.currentPage) {
                            return;
                        }
                        state.currentPage = page;
                        renderTerms();
                    });
                    paginationPagesContainer.appendChild(button);
                };

                const addEllipsis = () => {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-3 py-2 text-sm text-gray-400';
                    ellipsis.textContent = '...';
                    paginationPagesContainer.appendChild(ellipsis);
                };

                const pagesToShow = new Set([1, totalPages]);

                for (let page = state.currentPage - 1; page <= state.currentPage + 1; page += 1) {
                    if (page > 1 && page < totalPages) {
                        pagesToShow.add(page);
                    }
                }

                const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);

                sortedPages.forEach((page, index) => {
                    if (index > 0) {
                        const previous = sortedPages[index - 1];
                        if (page - previous > 1) {
                            addEllipsis();
                        }
                    }
                    addPageButton(page);
                });
            };

            const renderTerms = () => {
                termsBody.innerHTML = '';

                const filteredTerms = getFilteredTerms();
                const total = filteredTerms.length;
                const totalPages = Math.max(1, Math.ceil(total / pageSize));

                state.currentPage = Math.min(state.currentPage, totalPages);
                state.currentPage = Math.max(state.currentPage, 1);

                const startIndex = total === 0 ? 0 : (state.currentPage - 1) * pageSize;
                const visibleTerms = total === 0 ? [] : filteredTerms.slice(startIndex, startIndex + pageSize);
                const isFiltering = state.searchQuery.trim().length > 0;
                const hasVisibleTerms = visibleTerms.length > 0;

                if (!hasVisibleTerms) {
                    termsBody.classList.remove('divide-y', 'divide-gray-200');
                    const emptyMessage = total === 0 && isFiltering
                        ? 'No terms match your search. Try different keywords.'
                        : 'No terminology entries yet. Use “Add Term” to create a new entry.';
                    renderEmptyState(emptyMessage);
                } else {
                    termsBody.classList.add('divide-y', 'divide-gray-200');
                    visibleTerms.forEach((term) => {
                        const row = state.bulkEditMode ? renderBulkRow(term) : renderDisplayRow(term);
                        termsBody.appendChild(row);
                    });
                }

                const displayStart = hasVisibleTerms ? startIndex + 1 : 0;
                const displayEnd = hasVisibleTerms ? startIndex + visibleTerms.length : 0;

                bulkToolbar.classList.toggle('hidden', !state.bulkEditMode);
                bulkEditButton.textContent = state.bulkEditMode ? 'Exit Bulk Edit' : 'Bulk Edit';
                bulkEditButton.setAttribute('aria-pressed', state.bulkEditMode ? 'true' : 'false');

                updateSummary(displayStart, displayEnd, total, isFiltering);
                renderPaginationControls(total, totalPages);
                updateControlsAvailability();
            };

            const exitBulkEdit = () => {
                if (state.bulkEditMode) {
                    state.bulkEditMode = false;
                    renderTerms();
                }
            };

            const generateId = () => nextId++;

            const handleDeleteTerm = (termId) => {
                const target = state.terms.find((item) => item.id === termId);
                if (!target) {
                    return;
                }

                const confirmed = window.confirm(`Delete "${target.term}"? This action cannot be undone.`);
                if (!confirmed) {
                    return;
                }

                state.terms = state.terms.filter((item) => item.id !== termId);
                if (state.terms.length === 0) {
                    state.bulkEditMode = false;
                }
                renderTerms();
            };

            const showPanel = () => {
                if (!panel.classList.contains('hidden')) {
                    return;
                }

                lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : addTermButton;

                panel.setAttribute('aria-hidden', 'false');
                backdrop.setAttribute('aria-hidden', 'false');

                panel.classList.remove('hidden');
                backdrop.classList.remove('hidden');

                requestAnimationFrame(() => {
                    panel.classList.remove('translate-x-full');
                    panel.classList.add('translate-x-0');
                    backdrop.classList.remove('opacity-0');
                    backdrop.classList.add('opacity-100');
                    firstField.focus({ preventScroll: true });
                });
            };

            const hidePanel = () => {
                if (panel.classList.contains('hidden')) {
                    return;
                }

                panel.classList.add('translate-x-full');
                panel.classList.remove('translate-x-0');
                backdrop.classList.remove('opacity-100');
                backdrop.classList.add('opacity-0');

                let hasClosed = false;
                let fallbackTimeout = null;

                const finalizeClose = () => {
                    if (hasClosed) {
                        return;
                    }

                    hasClosed = true;

                    if (fallbackTimeout !== null) {
                        window.clearTimeout(fallbackTimeout);
                    }

                    panel.classList.add('hidden');
                    backdrop.classList.add('hidden');
                    panel.setAttribute('aria-hidden', 'true');
                    backdrop.setAttribute('aria-hidden', 'true');
                    addTermForm.reset();
                    state.editingTermId = null;

                    const focusTarget = lastFocusedElement && typeof lastFocusedElement.focus === 'function'
                        ? lastFocusedElement
                        : addTermButton;

                    focusTarget.focus({ preventScroll: true });
                };

                const handleTransitionEnd = (event) => {
                    if (event.target === panel) {
                        finalizeClose();
                    }
                };

                panel.addEventListener('transitionend', handleTransitionEnd, { once: true });
                panel.addEventListener('transitioncancel', handleTransitionEnd, { once: true });

                fallbackTimeout = window.setTimeout(finalizeClose, 400);
            };

            const openTermPanel = (mode, termId = null) => {
                exitBulkEdit();
                state.editingTermId = mode === 'edit' ? termId : null;
                panelTitle.textContent = mode === 'edit' ? 'Edit Term' : 'Add New Term';
                addTermForm.reset();

                if (mode === 'edit' && termId !== null) {
                    const term = state.terms.find((item) => item.id === termId);
                    if (!term) {
                        return;
                    }

                    termNameInput.value = term.term;
                    termDefinitionInput.value = term.definition;
                    termSynonymsInput.value = term.synonyms.join(', ');
                }

                showPanel();
            };

            const handleFormSubmit = (event) => {
                event.preventDefault();

                const name = termNameInput.value.trim();
                const definition = termDefinitionInput.value.trim();
                const synonyms = parseSynonyms(termSynonymsInput.value);
                let shouldResetPage = false;

                if (!name) {
                    termNameInput.focus({ preventScroll: true });
                    return;
                }

                const timestamp = formatDisplayDate(new Date());

                if (state.editingTermId !== null) {
                    const term = state.terms.find((item) => item.id === state.editingTermId);
                    if (term) {
                        term.term = name;
                        term.definition = definition;
                        term.synonyms = synonyms;
                        term.lastChange = timestamp;
                    }
                } else {
                    state.terms.unshift({
                        id: generateId(),
                        term: name,
                        definition,
                        synonyms,
                        lastChange: timestamp
                    });
                    shouldResetPage = true;
                }

                hidePanel();
                if (shouldResetPage) {
                    state.currentPage = 1;
                }
                renderTerms();
            };

            const handleBulkSave = () => {
                if (!state.bulkEditMode) {
                    return;
                }

                const rows = Array.from(termsBody.querySelectorAll('[data-term-id]'));
                rows.forEach((row) => {
                    const termId = Number.parseInt(row.dataset.termId, 10);
                    const term = state.terms.find((item) => item.id === termId);
                    if (!term) {
                        return;
                    }

                    const termInput = row.querySelector('[data-field="term"]');
                    const definitionInput = row.querySelector('[data-field="definition"]');
                    const synonymsInput = row.querySelector('[data-field="synonyms"]');
                    const lastChangeInput = row.querySelector('[data-field="lastChange"]');

                    if (termInput) {
                        const updatedTerm = termInput.value.trim();
                        if (updatedTerm) {
                            term.term = updatedTerm;
                        }
                    }

                    if (definitionInput) {
                        term.definition = definitionInput.value.trim();
                    }

                    if (synonymsInput) {
                        term.synonyms = parseSynonyms(synonymsInput.value);
                    }

                    if (lastChangeInput && lastChangeInput.value) {
                        term.lastChange = formatDisplayDate(new Date(lastChangeInput.value));
                    }
                });

                state.bulkEditMode = false;
                renderTerms();
            };

            const handleExport = () => {
                if (state.terms.length === 0) {
                    return;
                }

                const header = ['Term (Canonical)', 'Definition', 'Synonyms', 'Last Change'];
                const rows = state.terms.map((term) => [
                    escapeCsvValue(term.term),
                    escapeCsvValue(term.definition),
                    escapeCsvValue(term.synonyms.join('; ')),
                    escapeCsvValue(term.lastChange)
                ]);

                const csvContent = [header.map(escapeCsvValue).join(','), ...rows.map((row) => row.join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'terminology.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            searchInput.addEventListener('input', (event) => {
                state.searchQuery = event.target.value;
                state.currentPage = 1;
                renderTerms();
            });

            paginationPrevButton.addEventListener('click', () => {
                if (state.currentPage <= 1) {
                    return;
                }
                state.currentPage -= 1;
                renderTerms();
            });

            paginationNextButton.addEventListener('click', () => {
                const filteredCount = getFilteredTerms().length;
                const totalPages = Math.max(1, Math.ceil(filteredCount / pageSize));
                if (state.currentPage >= totalPages) {
                    return;
                }
                state.currentPage += 1;
                renderTerms();
            });

            bulkEditButton.addEventListener('click', () => {
                if (!state.bulkEditMode && state.terms.length === 0) {
                    return;
                }

                state.bulkEditMode = !state.bulkEditMode;
                renderTerms();
            });

            bulkCancelButton.addEventListener('click', () => {
                state.bulkEditMode = false;
                renderTerms();
            });

            bulkSaveButton.addEventListener('click', handleBulkSave);
            exportButton.addEventListener('click', handleExport);
            addTermButton.addEventListener('click', () => {
                openTermPanel('add');
            });

            addTermForm.addEventListener('submit', handleFormSubmit);
            backdrop.addEventListener('click', hidePanel);
            closeTriggers.forEach((trigger) => {
                trigger.addEventListener('click', hidePanel);
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (!panel.classList.contains('hidden')) {
                        hidePanel();
                    } else if (state.bulkEditMode) {
                        state.bulkEditMode = false;
                        renderTerms();
                    }
                }
            });

            renderTerms();
    };

    const resetAndInit = () => {
        initialized = false;
        init();
    };

    const handleInitEvent = (event) => {
        const targetPage = event?.detail?.page;
        if (targetPage && targetPage !== PAGE_KEY) {
            return;
        }
        resetAndInit();
    };

    const attach = () => {
        document.addEventListener('ai-assistant:init-page', handleInitEvent);
    };

    const detach = () => {
        document.removeEventListener('ai-assistant:init-page', handleInitEvent);
        initialized = false;
    };

    window.AIAssistant = window.AIAssistant || {};
    window.AIAssistant.pages = window.AIAssistant.pages || {};
    const previous = window.AIAssistant.pages[PAGE_KEY];
    if (previous && typeof previous.teardown === 'function') {
        previous.teardown();
    }

    window.AIAssistant.pages[PAGE_KEY] = {
        init: resetAndInit,
        teardown: detach,
    };

    attach();

    const shouldAutoInit = !window.AIAssistant?.navigation?.isNavigating;
    if (shouldAutoInit) {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init, { once: true });
        } else {
            init();
        }
    }
})();
</script>

</body></html>
